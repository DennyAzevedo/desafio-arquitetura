@startuml Desafio - Diagrama de Container - Ideal
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

Person(user, "Comerciante")

System_Boundary(cfs, "Cash Flow System - Arquitetura Ideal") {

    Container(apigw, "API Gateway", "NGINX/YARP/Kong", "Autenticação, Rate Limit, Roteamento")

    Container(transactionService, "Transaction Service", "ASP.NET Core", "Processa lançamentos, Outbox, publica em Kafka")

    Container(consolidationService, "Consolidation Service", "ASP.NET Core", "Consome eventos, atualiza read model, expõe consultas")

    ContainerDb(transactionDb, "TransactionDB", "PostgreSQL", "Transações + Outbox")

    ContainerDb(readDb, "ReadDB", "PostgreSQL", "Modelo de leitura consolidado")

    Container(redisCache, "Cache", "Redis", "Cache de consultas de saldo (Ideal)")

}

System_Ext(kafka, "Kafka Cluster", "Mensageria escalável")
System_Ext(authProvider, "OIDC Provider", "Keycloak/AzureAD/Auth0")
System_Ext(vault, "Vault", "Secrets management")
System_Ext(otel, "OpenTelemetry Collector", "Tracing/Metrics/Logs")

Rel(user, apigw, "Chamada autenticada (OIDC)")
Rel(apigw, transactionService, "Encaminha requisições")
Rel(apigw, consolidationService, "Encaminha requisições")

Rel(transactionService, transactionDb, "CRUD")
Rel(transactionService, kafka, "Publica eventos TransactionCreated")

Rel(kafka, consolidationService, "Entrega eventos")
Rel(consolidationService, readDb, "Atualiza saldo")
Rel(consolidationService, redisCache, "Cache (read)")

Rel(transactionService, vault, "Obtém segredos")
Rel(consolidationService, vault, "Obtém segredos")

Rel(transactionService, otel, "Logs/Traces")
Rel(consolidationService, otel, "Logs/Traces")

@enduml
